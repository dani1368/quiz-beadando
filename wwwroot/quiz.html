<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kv√≠z ‚Äì Jogos√≠tv√°ny Teszt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    #rulesBox {
      border-left: 5px solid #0d6efd;
      background: #f8f9fa;
      padding: 1.25rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.05);
    }

    #quizStickyBar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f1f1f1;
      border-top: 1px solid #ccc;
      padding: 0.75rem 1.5rem;
      z-index: 1050;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #quizStickyBar .timer {
      font-weight: bold;
      font-size: 1.25rem;
      color: #dc3545;
    }

    #quizContainer img {
      max-width: 200px;
      max-height: 150px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/index.html">Jogos√≠tv√°ny Teszt</a>
      <div class="navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a href="/login.html" id="loginNav" class="nav-link d-none">Bejelentkez√©s</a></li>
          <li class="nav-item"><a href="/register.html" id="signupNav" class="nav-link d-none">Regisztr√°ci√≥</a></li>
          <li class="nav-item"><a href="/account.html" id="accountNav" class="nav-link d-none">Fi√≥kom</a></li>
          <li class="nav-item"><a href="#" id="logoutNav" class="nav-link d-none">Kijelentkez√©s</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <h2 class="mb-4" id="quizTitle">üìù Kv√≠z Szab√°lyok</h2>

    <div id="rulesBox" class="mb-4">
      <p><strong>üëâ A kv√≠z menete:</strong></p>
      <ul>
        <li>√ñsszesen <strong>10 k√©rd√©s</strong>.</li>
        <li>Kit√∂lt√©si id≈ë: <strong>5 perc</strong>.</li>
        <li>Lej√°rat vagy megszak√≠t√°s eset√©n az addigi v√°laszaid ment√©sre ker√ºlnek.</li>
        <li>Bek√ºld√©s ut√°n az eredm√©nyt azonnal megkapod.</li>
      </ul>
      <button id="startQuizBtn" class="btn btn-primary mt-3">Kv√≠z ind√≠t√°sa</button>
    </div>

    <div id="alert-container" class="mb-3"></div>

    <form id="quizForm" class="d-none">
      <div id="quizContainer"></div>
    </form>
  </main>

  <div id="quizStickyBar">
    <div class="timer" id="timerDisplay">00:00</div>
    <div>
      <button type="button" class="btn btn-outline-danger me-2" id="cancelQuizBtn">Megszak√≠t√°s</button>
      <button type="submit" form="quizForm" class="btn btn-success">Bek√ºld√©s</button>
    </div>
  </div>

  <script src="/js/nav.js"></script>
  <script type="module" src="/js/alert.js"></script>
  <script type="module">
    import { showAlert, clearAlert } from '/js/alert.js';

    let startTime = null;
    let duration = 300;
    let timer = null;

    function resetQuizUI() {
      clearInterval(timer);
      $('#timerDisplay').text('');
      $('#quizForm').addClass('d-none');
      $('#quizContainer').empty();
      $('#rulesBox').slideDown();
      $('#quizTitle').text('üìù Kv√≠z Szab√°lyok');
      $('#quizStickyBar').slideUp();
      clearAlert();
    }

    function escapeHtml(s) {
      return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
              .replace(/\"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function startTimer(startUnix) {
      const end = startUnix + duration;
      $('#quizStickyBar').slideDown();

      timer = setInterval(() => {
        const now = Math.floor(Date.now() / 1000);
        const left = end - now;

        if (left <= 0) {
          clearInterval(timer);
          $('#timerDisplay').text("Lej√°rt!");
          $('#quizForm button[type=submit]').prop('disabled', true);
          showAlert("‚è∞ Lej√°rt az id≈ë! A kv√≠z automatikusan lez√°r√°sra ker√ºl.", "warning");
          submitQuiz();
        } else {
          const m = String(Math.floor(left / 60)).padStart(2, '0');
          const s = String(left % 60).padStart(2, '0');
          $('#timerDisplay').text(`‚è±Ô∏è ${m}:${s}`);
        }
      }, 1000);
    }

    function render(questions) {
      clearAlert();
      $('#quizForm').removeClass('d-none');
      $('#rulesBox').slideUp();
      $('#quizTitle').text('üß™ Akt√≠v Kv√≠z');

      $('#quizContainer').empty();
      questions.forEach((q, i) => {
        let html = `<div class='mb-5 border rounded p-3 shadow-sm bg-light'>`;
        html += `<h5>${i + 1}. ${escapeHtml(q.text)}</h5>`;
        if (q.imageUrls?.length) {
          html += `<div class='d-flex flex-wrap gap-2 mb-2'>`;
          q.imageUrls.forEach(url => {
            html += `<img src='${url}' class='img-fluid rounded border'>`;
          });
          html += `</div>`;
        }
        html += `<div class='form-check-group mt-2'>`;
        q.answers.forEach(a => {
          html += `<div class='form-check'>
            <input class='form-check-input' type='radio' name='q${q.id}' id='a${a.id}' value='${a.id}' required>
            <label class='form-check-label' for='a${a.id}'>${escapeHtml(a.text)}</label>
          </div>`;
        });
        html += `</div></div>`;
        $('#quizContainer').append(html);
      });
    }

    async function getCurrentQuiz() {
      try {
        const res = await fetch('/api/quiz/current');
        if (res.status === 401) return showAlert("K√©rlek, jelentkezz be a kv√≠zhez.", "danger");
        if (res.status === 204) return;

        const data = await res.json();
        startTime = data.startTime;
        duration = data.duration;
        render(data.questions);
        startTimer(startTime);
      } catch {
        showAlert("Nem siker√ºlt bet√∂lteni a jelenlegi kv√≠zt.", "danger");
      }
    }

    async function submitQuiz() {
      const form = new FormData(document.getElementById('quizForm'));
      try {
        const res = await fetch('/api/quiz/submit', { method: 'POST', body: form });
        const result = await res.json();

        if (!res.ok) {
          showAlert(result.message || "Nem siker√ºlt bek√ºldeni a kv√≠zt.", "danger");
          return;
        }

        clearInterval(timer);
        $('#quizStickyBar').slideUp();
        $('#quizForm').addClass('d-none');
        $('#quizContainer').empty();
        $('#quizTitle').text('üèÅ Kv√≠z v√©ge');
        clearAlert();

        // √Åtir√°ny√≠t√°s az eredm√©ny oldalra
        window.location.href = '/view_quiz.html?id=' + result.sessionId;
      } catch {
        showAlert("Hiba t√∂rt√©nt a bek√ºld√©s sor√°n.", "danger");
      }
    }

    $('#startQuizBtn').click(async () => {
      try {
        const res = await fetch('/api/quiz/start');
        if (!res.ok) {
          const err = await res.json();
          showAlert(err.message || "Nem siker√ºlt elind√≠tani a kv√≠zt.", "danger");
          return;
        }

        const data = await res.json();
        startTime = data.startTime;
        duration = data.duration;
        render(data.questions);
        startTimer(startTime);
      } catch {
        showAlert("Hiba t√∂rt√©nt a kv√≠z ind√≠t√°sa sor√°n.", "danger");
      }
    });

    $('#cancelQuizBtn').click(async () => {
      await submitQuiz(); // √ºres form = megszak√≠t√°s
    });

    $('#quizForm').submit(async e => {
      e.preventDefault();
      await submitQuiz();
    });

    getCurrentQuiz();
    $('#quizStickyBar').hide();
  </script>
</body>
</html>