<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kv√≠z Eredm√©ny ‚Äì Jogos√≠tv√°ny Teszt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .question-box {
      background: #f8f9fa;
      border-left: 4px solid #0d6efd;
      padding: 1.25rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .correct-answer {
      background-color: #d4edda;
      border-left: 4px solid #28a745;
    }
    .wrong-answer {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
    }
    .selected {
      font-weight: bold;
    }
    img.result-image {
      max-width: 200px;
      max-height: 150px;
      border-radius: 0.25rem;
      border: 1px solid #ccc;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/index.html">Jogos√≠tv√°ny Teszt</a>
    <div class="navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a href="/login.html" id="loginNav" class="nav-link d-none">Bejelentkez√©s</a></li>
        <li class="nav-item"><a href="/register.html" id="signupNav" class="nav-link d-none">Regisztr√°ci√≥</a></li>
        <li class="nav-item"><a href="/account.html" id="accountNav" class="nav-link d-none">Fi√≥kom</a></li>
        <li class="nav-item"><a href="#" id="logoutNav" class="nav-link d-none">Kijelentkez√©s</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container py-5">
  <h2 class="mb-4">üìä Kv√≠z eredm√©ny</h2>
  <div id="resultScore" class="alert alert-success fw-bold fs-5"></div>
  <div id="resultContent"></div>
  <div class="mt-4 d-flex gap-3">
    <a href="/account.html" class="btn btn-outline-primary">üìö Vissza a fi√≥khoz</a>
    <a href="/index.html" class="btn btn-success">üè† Kezd≈ëlap</a>
  </div>
</main>

<script src="/js/nav.js"></script>
<script>
  const sessionId = new URLSearchParams(window.location.search).get("id");

  if (!sessionId) {
    $("#resultContent").html("<div class='alert alert-danger'>‚ùå Hi√°nyz√≥ kv√≠z azonos√≠t√≥.</div>");
    throw new Error("Missing sessionId");
  }

  function escapeHtml(s) {
    return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
            .replace(/\"/g, '&quot;').replace(/'/g, '&#039;');
  }

  fetch(`/api/quiz/view/${sessionId}`)
      .then(async res => {
        if (!res.ok) {
          if (res.status === 401) {
            throw new Error("Nem vagy bejelentkezve.");
          }
          const error = await res.json();
          throw new Error(error.message || "Ismeretlen hiba.");
        }
        return res.json();
    })
    .then(data => {
      $("#resultScore").text(`‚úÖ El√©rt pontsz√°m: ${data.score} / ${data.total}`);

      data.questions.forEach((q, i) => {
        let html = `<div class='question-box'>`;
        html += `<h5>${i + 1}. ${escapeHtml(q.text)}</h5>`;

        if (q.imageUrls?.length) {
          html += `<div class='d-flex flex-wrap gap-2 mb-2'>`;
          q.imageUrls.forEach(url => {
            html += `<img src='${url}' class='result-image'>`;
          });
          html += `</div>`;
        }

        html += `<ul class='list-group'>`;
        q.answers.forEach(a => {
          const isSelected = a.id === q.selectedAnswerId;
          const isCorrect = a.isCorrect;
          let cls = "list-group-item";

          if (isCorrect) cls += " correct-answer";
          else if (isSelected) cls += " wrong-answer";

          if (isSelected) cls += " selected";

          html += `<li class='${cls}'>${escapeHtml(a.text)}</li>`;
        });
        html += `</ul></div>`;

        $("#resultContent").append(html);
      });
    })
    .catch(err => {
      console.error(err);
      $("#resultScore").hide();
      $("#resultContent").html("<div class='alert alert-danger'>‚ùå Nem siker√ºlt bet√∂lteni az eredm√©nyt.</div>");
    });
</script>
</body>
</html>
